#include "marklin/train/model_defaults.h"
#include "marklin/train/kinematics.h"
#include "marklin/train/model.h"
#include "marklin/common/constants.h"
#include "string.h"

// ############################################################################
// # Train Model Defaults Implementation
// # Uses lazy initialization pattern to prevent data section issues
// ############################################################################

#define TRAIN_DEFAULTS_COUNT 6

// Initialize all train default parameters with lazy initialization
static const train_model_defaults_t *get_all_train_defaults(void)
{
	static train_model_defaults_t train_defaults[TRAIN_DEFAULTS_COUNT];
	static bool initialized = false;

	if (!initialized) {
		// Initialize train 14 parameters
		// clang-format off
		static kinematic_speed_params_t train_14_speeds[KINEMATIC_TOTAL_SPEED_LEVELS] = {
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{153681365,641866,0,0,0,0,0,0},
			{178249235,586348,0,0,0,0,0,0},
			{223871520,368513,0,0,0,0,0,0},
			{227685546,500541,0,0,0,0,0,0},
			{254530567,503445,0,0,0,0,0,0},
			{279858360,45087,1014516,386,275,0,0,0},
			{306373193,38545,948126,495,322,0,0,0},
			{335951008,33498,1027896,549,326,0,0,0},
			{368325434,33873,1073288,632,343,0,0,0},
			{399229452,39122,1072571,743,371,0,0,0},
			{434171322,30181,1146622,822,378,0,0,0},
			{464442231,27704,1182601,912,392,0,0,0},
			{498183760,24559,1156510,1073,429,0,0,0},
			{528684807,15182,1178362,1186,448,0,0,0},
			{564527845,151,1321275,1206,425,0,0,0},
			{604015544,0,1253727,1455,481,0,0,0},
		};

		// Initialize train 15 parameters (empty for now)
		static kinematic_speed_params_t train_15_speeds[KINEMATIC_TOTAL_SPEED_LEVELS] = {
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
		};

		// Initialize train 16 parameters
		static kinematic_speed_params_t train_16_speeds[KINEMATIC_TOTAL_SPEED_LEVELS] = {
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{278584624,0,0,0,0,0,0,0},
			{307167868,0,0,0,0,0,0,0},
			{337852838,0,0,0,0,0,0,0},
			{370042766,0,0,0,0,0,0,0},
			{400601373,0,0,0,0,0,0,0},
			{434196634,0,0,0,0,0,0,0},
			{465369260,0,0,0,0,0,0,0},
			{495143112,0,0,0,0,0,0,0},
			{525369932,0,0,0,0,0,0,0},
			{559614874,0,0,0,0,0,0,0},
			{602695066,0,0,0,0,0,0,0},
		};

		// Initialize train 17 parameters (empty for now)
		static kinematic_speed_params_t train_17_speeds[KINEMATIC_TOTAL_SPEED_LEVELS] = {
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
		};

		// Initialize train 18 parameters (empty for now)
		static kinematic_speed_params_t train_18_speeds[KINEMATIC_TOTAL_SPEED_LEVELS] = {
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{0,0,0,0,0,0,0,0},
			{117509198,0,0,0,0,0,0,0},
			{138040260,0,0,0,0,0,0,0},
			{161237897,0,0,0,0,0,0,0},
			{186370903,0,0,0,0,0,0,0},
			{212340619,0,0,0,0,0,0,0},
			{238638689,0,0,0,0,0,0,0},
			{267067583,0,0,0,0,0,0,0},
			{292167919,46919,0,440,300,0,0,0},
			{321143250,48278,0,491,304,0,0,0},
			{353257575,38326,0,577,325,0,0,0},
			{388583333,33325,0,657,337,0,0,0},
			{422373188,30776,0,0,0,0,0,0},
			{457156862,0,0,0,0,0,0,0},
			{488784067,0,0,0,0,0,0,0},
			{521588366,0,0,0,0,0,0,0},
			{559112709,0,0,0,0,0,0,0},
			{593256997,0,0,0,0,0,0,0},
			{637021857,0,0,0,0,0,0,0},
		};

		// Initialize train 55 parameters (empty for now)
		static kinematic_speed_params_t train_55_speeds[KINEMATIC_TOTAL_SPEED_LEVELS] = {
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
			{ 0, 0, 0, 0, 0, 0, 0, 0 },
		};

		// clang-format on

		// Set up train defaults array
		train_defaults[0] = (train_model_defaults_t){ .train_id = 14, .default_speeds = train_14_speeds };
		train_defaults[1] = (train_model_defaults_t){ .train_id = 15, .default_speeds = train_15_speeds };
		train_defaults[2] = (train_model_defaults_t){ .train_id = 16, .default_speeds = train_16_speeds };
		train_defaults[3] = (train_model_defaults_t){ .train_id = 17, .default_speeds = train_17_speeds };
		train_defaults[4] = (train_model_defaults_t){ .train_id = 18, .default_speeds = train_18_speeds };
		train_defaults[5] = (train_model_defaults_t){ .train_id = 55, .default_speeds = train_55_speeds };

		initialized = true;
	}

	return train_defaults;
}

// Public interface function
const train_model_defaults_t *get_train_model_defaults(u8 train_id)
{
	const train_model_defaults_t *all_defaults = get_all_train_defaults();

	for (int i = 0; i < TRAIN_DEFAULTS_COUNT; i++) {
		if (all_defaults[i].train_id == train_id) {
			return &all_defaults[i];
		}
	}

	return NULL;
}
